---
title: "Trabajo Práctico I"
author: "A. Verri Kozlowski y F. Patitucci"
subtitle: Aprendizaje Estadístico -  (84:04)
output:
  pdf_document:
    toc: yes
    number_sections: no
    latex_engine: xelatex
    keep_tex: no
  html_document:
    toc: yes
    df_print: paged
  word_document:
    toc: yes
---

```{r warning=FALSE, include=FALSE}
#lib
library(ggplot2)
library(data.table) # data,frame extendido
library(ggthemes) 
library(flextable) # Plot Tables
library(GGally)
library(leaps)

# knit options ----
knitr::opts_chunk$set(out.width="50%",fig.align = "center",eval=TRUE, echo = FALSE, warning = FALSE, size = "small")
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

knitr::opts_chunk$set(echo = TRUE)
# out_type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
getOutputFormat <- function() {
  output <- rmarkdown:::parse_yaml_front_matter(
    readLines(knitr::current_input())
    )$output
  if (is.list(output)){
    return(names(output)[1])
  } else {
    return(output[1])
  }
}

# rnd  
set.seed(25111970)

# flextable  ----
use_df_printer()
set_flextable_defaults(
  font.size = 10,border.color = "gray",
  padding.bottom = 3,   padding.top = 3,
  padding.left = 4,  padding.right = 4,
  post_process_html = function(x){
    # theme_booktabs(x)  |>
    theme_vanilla(x) |>
      set_table_properties(layout = "autofit") |>
      autofit() |>
      align(align="center",part = "header") |>
      bold(part = "header")  |> 
      fontsize(size = 10, part = "header")|> 
      fontsize(size = 10, part = "body")
  },
  post_process_pdf = function(x){
    # theme_booktabs(x)  |>
      theme_vanilla(x) |>
      set_table_properties(layout = "autofit") |>
      autofit() |>
      align(align="center",part = "header") |>
      bold(part = "header")  |>
      fontsize(size = 9, part = "header")|> 
      fontsize(size = 9, part = "body")
  },
  post_process_docx = function(x){
    theme_vanilla(x) |>
      set_table_properties(layout = "autofit") |>
      autofit() |>
      align(align="center",part = "header") |>
      bold(part = "header")  |>
      fontsize(size = 10, part = "header")|> 
      fontsize(size = 9, part = "body")
  }
) 
```

*El dataset `diabetes2.csv` es original del National Institute of Diabetes and Digestive and Kidney Diseases. Se creó con el objetivo de predecir si un paciente tiene o no diabetes, basado en diferentes medidas contenidas en el dataset. En particular, todos los pacientes son de sexo femenino mayores de 21 a~nos de herencia Pima. Para este primer estudio, lo que buscaremos es encontrar relaciones entre otras de las variables contenidas en el dataset.*

## Ejercicio 1
Cargar los datos de diabetes2.csv. La variable Outcome indica si la persona es diabética (1) o no (0). Transformarla en un factor. Finalmente revisar que todas las variables contenidas en el dataframe estén correctamente definidas.

```{r echo=TRUE,include=FALSE}
# data <- read.csv("data/diabetes2.csv", header = TRUE)
DT <-fread(file=file.path("data","diabetes2.csv"))
DT[,V1:=NULL]
DT[,Outcome:=as.factor(Outcome)]
setnames(DT,
         old=c("Pregnancies","Glucose" ,"BloodPressure", "SkinThickness" ,"Insulin" ,"DiabetesPedigreeFunction", "Age" ,"Outcome"),
         new=c("P","G" ,"BP", "ST" ,"I" ,"DPF", "A" ,"O"))
```
Mediante un análisis de los datos del set, se observan muchas variables definidas como enteros, `int` que en algunos casos representan variables discretas cardinales tales como la cantidad de embarazos`(Pregnancies,)`, ordinales tales como la edad `(Age)` o nominales binarias tales como`(Outcomes)` y en otros casos, representan variable reales, tales como `Age`. Para facilitar la representación de algunas figuras, se elimina la columna de índice, se renombran las variables del dataset original. El tipo de dato `int` del dataset no afecta los algoritmos del modelo de regresión y no requieren tratamiento

La figura siguiente muestra un diagrama de cajas (boxPlot) para las variables continuas

```{r echo=FALSE}
boxplot(DT)
```

La inspección del dataset indica que existen `r nrow(DT[I==0])` observaciones con `I=0`y el primer valor diferente a 0 es 14. A partir del boxPlot puede apreciarse que la variable `I (Insulin)` tiene algunos valores que en apariencia parecen ser outliers pero eso es debido a las escalas diferentes. Los datos estandarizados (no centrados) muestran el siguiente diagrama de cajas

```{r echo=FALSE}
DTS <- DT[,.(G=scale(G,center = TRUE),I=scale(I,center = TRUE),BMI=scale(BMI,center = TRUE),DPF=scale(DPF,center = TRUE),BP=scale(BP,center = TRUE),ST=scale(ST,center = TRUE),A=scale(A,center = TRUE),P=scale(P,center = TRUE))]
boxplot(DTS)
```


<!-- Se ve que las siguientes variables debieron ser definidas como num en vez de int, ya que son continuas y no discretas. -->

<!-- -   Glucose -->
<!-- -   BloodPressure -->
<!-- -   SkinThickness -->
<!-- -   Insulin -->




## Ejercicio 2
_Se desea ajustar un modelo de regresión múltiple para predecir la variable BMI en función del resto de las variables en el data set. Escribir el modelo propuesto, indicando los supuestos del mismo._

Sea una variable aleatoria $Y$ definida como una función de un vector de variables aleatorias $X$ según el siguiente modelo

$$Y=\beta_0 + \beta_1 X_{1}+ \beta_2 \cdot X_{2} + ... + \beta_p X_{p}+ \varepsilon $$, 

donde $\varphi(X)$ es la mediana condicional de $Y$ y $\varepsilon$ es una variable aleatoria con valor medio nulo $\mathbb{E}[\varepsilon]=0$ y varianza constante $\mathbb{VAR}[\varepsilon]=\sigma^2$

La mediana condicional $ Y \approx \varphi(X)$ es una función expresada en términos de los parámetros $\beta_i$ 


$$Y\approx\varphi(X)= \beta_0 + \beta_1 X_{1}+ \beta_2 \cdot X_{2} + ... + \beta_p X_{p}$$
El objeto de este análisis será poder encontrar un estimador de la mediana condicional $\hat y = \hat\varphi(x)$ a partir de los estimadores $\hat\beta_i$ y un vector de observaciones $x$ según
$$\hat\varphi(x) = \hat y =\hat\beta_0 + \hat\beta_1 x_{1}+ \hat\beta_2 \cdot x_{2} + ... + \hat\beta_p x_{p}$$
Para el problema de Diabetes, se busca estimar la mediana condicional del parámetro $Y=BMI$ en función de las variables restanes y el modelo lineal queda expresado según:


$\hat\varphi(x) = \hat {BMI} = \beta_0 + \beta_1 \ P + \beta_2 G + \beta_3 \  BP+ \beta_4 \ ST+ \beta_5 \ I + \beta_6 \ DPF+ \beta_7 \ A + \beta_8 \ O + \varepsilon$

en donde $\hat y = \hat {BMI}$ es un estimador de mediana condicional de la variable aleatoria $Y=BMI$ y 
- `P (Pregnancies)`,`G (Glucose)`,`BP (BloodPressure)` `ST (SkinThickness)` `I (Insulin)`
`DPF (DiabetesPedigreeFunction)`, `A (Age)`, y $O$ es una variable ordinal binaria (lógica) $\mathbb{I} \left( Outcome = 1 \right)$ 

Los supuestos del modelo que están implícitos aquí son los siguientes:

-   Los errores $\varepsilon_i$ tienen media cero, $\mathbb{E}\left[\varepsilon_i \right] = 0$
-   Los errores $\varepsilon_i$ tienen idnéntica varianza $\mathbb{VAR}\left[\varepsilon_i \right] = \sigma^2$
-   Los errores $\varepsilon_i$ tienen distribución Normal. 
-   Los errores $\varepsilon_i$ son independientes entre sí y no están correlacionados con las covariables $x_i$

Los estimadores $\beta_i$ del modelo, quedan determinados segun la expresión:

y a partir de la función `lm()` de R, se obtienen directamente según
```{r echo=TRUE}
Modelo <- lm( BMI ~ P + G + BP + ST + I + DPF + A + O, data = DT)
Coeff <- Modelo$coefficients
```

<!-- Aca habria que agregar una tabla mostrando los valores de cada una de las variables -->

```{r echo=FALSE}
t(Coeff) %>% as.data.table() %>% flextable() |>  colformat_double(digits = 4)
```


<!-- Estaría bueno agregar una explicación de cómo se calculan -->
<!-- Explicar matrices X -->

<!-- Se aclara que la matriz  β ̂ es el vector columna con los valores de los coeficientes -->
## Ejercicio 3
_Realizar un scatterplot de las variables con la función ggpairs_

```{r echo=FALSE,warning=FALSE,include=TRUE}
# data <- read.csv("data/diabetes2.csv", header = TRUE)
# data$Outcome<-factor(data$Outcome)
# data$Glucose<-as.numeric(data$Glucose)
# data$BloodPressure<-as.numeric(data$BloodPressure)
# data$SkinThickness<-as.numeric(data$SkinThickness)
# data$Insulin<-as.numeric(data$Insulin)
# ggpairs(data[2:10])
ggpairs(DT,aes(color = O, alpha = 0.5), 
         upper = list(continuous = wrap("cor", size = 2.5)),
        lower = list(combo = wrap(ggally_facethist, binwidth = 1)))
```

## Ejercicio 4
_A partir de la tabla de correlaciones estimadas entre las variables, si tuviera que elegir una sola variable para proponer un modelo de regresión simple, ¿cuál eligiríaa y por qué?_



Para que se obtenga un buen modelo de predicción mediante una única variable lo que se debe buscar es que el coeficiente de correlación entre las variables en valor absoluto sea lo más cercano a 1 posible. Ya que mientras mas cerca del 1 nos encontremos implicara que existe una relación "mas lineal" entre estas dos. En caso de ser positiva nos habla de que ambas crecen en conjunto, en caso de ser negativa nos indica que si una decrece la otra crece. Cuando el coeficiente de correlación se acerca en modulo a cero implica que las variables no tienen una relación lineal. Hasta llegar al caso en que la correlación es nula que nos indica que las variables están descorrelacionadas.

-   Si se quiere predecir la variable Pregnancies elegiría Age

-   Si se quiere predecir la variable Glucose elegiría Insulin

-   Si se quiere predecir la variable Blood Pressure elegiría Age

-   Si se quiere predecir la variable Skin Thickness elegiría BMI

-   Si se quiere predecir la variable Insulin elegiría Glucose

-   Si se quiere predecir la variable BMI elegiría Skin Thickness

-   Si se quiere predecir la variable Diabetes Pedigree Function elegiría Glucose (en caso de facilitar el análisis podrían ser utilizadas BMI o Insulin)

-   Si se quiere predecir la variable Age elegiría Pregnancies

Se debe tener en cuenta que para este análisis se tuvo en cuenta el coeficiente de correlación de las variables, pero para un análisis más exhaustivo se debe tener presente la complejidad de medición de cada variable, además de otros factores particulares de esta área.

## Ejercicio 5
_Realizar un ajuste de regresión lineal múltiple. A partir de la tabla de coeficientes estimados, ¿Qué variables resultan significativas? ¿A qué nivel? ¿Cuál es el valor de la estimación para $\sigma^2$? Especificar las hipótesis nulas y alternativas para alguno de los test t reportados en la tabla, el estadístico del test y la regla de decisión. ¿Cómo se calcula el p-valor para este test?_

Antes de plantear el test de significancia, es importante notar que para esto se agrega el supuesto a nuestro modelo de que los errores tienen una distribución conjuntamente normal. Por lo tanto para un $X$ fijo

$Y \sim N_n \left( X \beta , \sigma^2 I \right)$

A partir de esto se plantea los siguientes test de hipótesis ( $i \in \left[ 1, 7 \right]$, no se testea para $\beta_0$ ya que el mismo actúa como un pasabajos, mejorando nuestro modelo)

**Test**

$H_0 : \beta_i=0 \: vs \: H_1 : \beta_i \neq 0$

La regla de decision a utilizar es

$\phi_{i}(X)= \left\{ \begin{array}{lcc} 1 & si & |T_i| > K_{\alpha_i} \\ \\ 0 & caso \; contrario \end{array} \right.$

Donde $T_i$ es nuentro estadistico, el cual tiene distribucion T de Student con $n-p$ grado de libertad, en este caso el grado de libertad es 530.

$T_i=\frac{ \hat{\beta_i}}{S\cdot d_{ii}}$

Donde $d_{ii}$ es el elemento $ii$ de la matriz $D=(X^{t}X)^{-1}$

De esta manera calculando el estadístico T para cada uno de los betas bajo la suposición de que la hipótesis nula es correcta, se debe calcular mediante la distribución T de Student, la probabilidad de obtener una realización igual o más extrema como la obtenida con la realización observada, esta probabilidad es el p valor.

<!-- REEMPLAZAR NS y usar notacion de clase -->
Las variables que se consideran significativas son todas aquellas las cuales tienen un Nivel de Significancia $NS \leq 0.05$, para este análisis basta con entrar al summary de la regresión realizada en R y ver uno por uno el $p_{valor}$ asociado a cada variable. Por lo tanto:

-   BloodPressure ($\textrm{p} \approx 0$)

-   SkinThickness ($\textrm{p} \approx 0$)

-   Insulin ($\textrm{p} = 0.0157$)

-   Age ($\textrm{p} = 0.0234$)

-   Outcome1 ($\textrm{p} \approx 0$)

La estimación de $\sigma^2$ es el cuadrado de Residual standard error brindado por summary, en este caso es de 24.8

```{r}
summary(Modelo)
```

## Ejercicio 6
_Evaluar la bondad del ajuste realizado, a través del coeficiente de determinación. Indicar cuánto vale y qué significa._ 


La bondad del ajuste puede ser medida por el estadístico $R^2$. El cual se define como

$$R^2=\frac{||\hat{Y}-\bar{Y}||^2}{||Y-\bar{Y}||^2}$$


$$R^2=\frac{||Y-\bar{Y}||^2-||Y-\hat{Y}||^2}{||Y-\bar{Y}||^2}$$

Donde

-   $Y$ valores verdaderos  
-   $\bar{Y}$ valores promedio  
-   $\hat{Y}$ valores estimados  

Esta última expresión permite una interpretación mas intuitiva. Se ve que en el numerador tenemos la suma de los errores cuadráticos entre los valores verdaderos y los promedios, menos la suma de los errores cuadráticos entre los valores verdaderos y los estimados, por último, en el denominador tenemos la suma de los errores cuadráticos entre los valores verdaderos y los promedios. Es lógico pensar que $R^2$ no puede tomar valores negativos ya que en caso de que eso pase implicaría que nuestro modelo predice peor que la media, y además claramente se ve que mientras mas se acerque a uno, implicara que la suma de los errores cuadráticos entre los valores verdaderos y los estimados tiende a cero, por lo tanto, nuestro modelo se encontrara mas ajustado. 

Se ve que $R^2$ es un estadístico muy útil para la comparación de modelos, pero se debe tener en cuenta que esta comparación se debe realizar con modelos del mismo orden ya que $R^2$ no considera al orden del mismo impidiendo la comparación para modelos de distinto orden (es de importancia destacar que existe un estadístico $R^2_{Ajustado}$ que tiene en cuenta este inconveniente).

En este modelo planteado $R^2=0.4825$ y $R^2_{Ajustado}=0.4747$

<!-- Construir esta tabla cn Flextable -->
<!-- 	      R^2	        R_Ajustado^2 -->
<!-- Modelo	0.4825    	0.4747 -->


## Ejercicio 7
_¿Es la regresión significativa? Especificar las hipótesis nula y alternativa de este test. ¿Cómo se calcula el p-valor en este caso? ¿Rechazaría a un nivel de significación de 0.05?_


Para analizar la significación del modelo de regresión se plantea el siguiente test de hipótesis

**Test**

$\begin{array}{cc} H_{0} : \beta_1 = \beta_2 = \beta_3 = \beta_4 = \beta_5 = \beta_6 = \beta_7 = \beta_8 = 0 & vs & H_1: \beta_{i} \neq 0 \; con \: i \in \left[ 1 , 8 \right] \end{array}$

La regla de decisión a utilizar es

$\phi_{i}(\underline{X})= \left\{ \begin{array}{lcc} 1 & si & F > F_{p-1,n-p,1-\alpha} \\ \\ 0 & caso \; contrario \end{array} \right.$

Donde $F$ es nuestro estadístico, el cual tiene distribución de Fischer-Snedecor con $(p-1, n-p)$ grados de libertad (en este caso $(8,530)$ grados de libertad).

$F=\frac{(C \hat{\beta}-\delta)^T (C(X^{T}X)^{-1}C^{T})^-1 (C \hat{\beta}-\delta)} {qS^{2}}$

Donde para la hipotesis nula:

- $C = \left[\begin{array}{cc} 
0&1&0&0&0&0&0&0&0\\ 
0&0&1&0&0&0&0&0&0\\ 
0&0&0&1&0&0&0&0&0\\
0&0&0&0&1&0&0&0&0\\
0&0&0&0&0&1&0&0&0\\
0&0&0&0&0&0&1&0&0\\ 
0&0&0&0&0&0&0&1&0\\
0&0&0&0&0&0&0&0&1
\end{array}\right]$

- $\delta = \left[\begin{array}{cc} 
0\\ 
0\\ 
0\\
0\\
0\\
0\\ 
0\\
0
\end{array}\right]$

Para calcular el $p_{valor}$ se debe calcular el valor de estadístico F bajo la condición de hipótesis nula y despejar la probabilidad asociada de ocurrencia de un valor igual o más extremo que el obtenido, esta probabilidad debe ser calculada  mediante la distribución F con los grados de libertad previamente nombrados.


<!-- Convertir este texto estático en resultados automaticos extraidos del modelo lm -->
En este caso, $F = 61.78$ con un $p_{valor} \approx 0$


<!-- Falta analizar caso p valor 0.05 -->
<!-- Yo creo que si se rechaza -->


## Ejercicio 8

_¿Cuál sería la estimación de la esperanza del BMI de una mujer tuvo 2 embarazos y tiene una concentración de glucosa de 100, una presión sistólica de 70, un valor de piel de triceps de 20, no tiene diabetes, un valor de la función pedigree de 0.24 y 30 años de edad?_

En este ejercicio se requiere una predicción de la esperanza condicional asumiendo una observación $x_o$, con la particularidad que la nueva observación no incuye valores de la variable `Insuline`. Para obtener esta estimación, se proponen dos caminos

El primer camino consiste en generar un nuevo modelo de predicción excluyendo a esta variable del set, y obtener una predicción para la nueva observación
(E[Y_0]) ̂=x_0^T  β ̂
 
Otra manera de estimar la esperanza condicional es emplear el modelo que ya tenemos, y 
(E[Y_0]) ̂=x_0^T  β ̂
```{r}
data <- read.csv("data/diabetes2.csv", header = TRUE)
data$Outcome<-factor(data$Outcome)
data$Glucose<-as.numeric(data$Glucose)
data$BloodPressure<-as.numeric(data$BloodPressure)
data$SkinThickness<-as.numeric(data$SkinThickness)
data$Insulin<-as.numeric(data$Insulin)
comb_opt_sins <- regsubsets( BMI ~ Pregnancies + Glucose + BloodPressure + SkinThickness + DiabetesPedigreeFunction + Age + Outcome, data = data, method = "exhaustive")

par(mfrow=c(2,2))
plot(summary(comb_opt_sins)$rss,pch="O",xlab="Modelo", ylab= "RSS", main ="RSS del Modelo")


plot(summary(comb_opt_sins)$rsq,pch="O",xlab="Modelo",ylim=c(.4,.5), ylab= "R^2", main ="R^2 del Modelo")

plot(summary(comb_opt_sins)$adjr2,pch="O",xlab="Modelo", ylab= "R^2 aj", main ="R^2 ajustado del Modelo")

plot(1:7,summary(comb_opt_sins)$cp,pch="O",xlim=c(0,10),ylim=c(0,10),xlab="Modelo", ylab= "CP", main ="Cp del Modelo")
abline(0,1)

Modelo8 <- lm( BMI ~ Pregnancies + BloodPressure + SkinThickness + DiabetesPedigreeFunction + Age + Outcome, data = data)

summary(Modelo8)

```







```{r}
#Se ve los rangos para verificar las hipotesis
range(data$Pregnancies, na.rm = TRUE)
range(data$BloodPressure, na.rm = TRUE)
range(data$SkinThickness, na.rm = TRUE)
range(data$DiabetesPedigreeFunction, na.rm = TRUE)
range(data$Age, na.rm = TRUE)

#se calcula la esperanza en el punto
X_0<-c(1,2,70,20,0.24,30,0)
E_y0<-sum(X_0*Modelo8$coefficients)
E_y0

```
## Ejercicio 9
_Hallar un intervalo de confianza y de predicción de nivel 0.95 para la estimación hallada en el ítem anterior._

### Intervalo de Confianza {-}
A partir de lo planteado en el ejercicio anterior y sabiendo que  $\hat Y_0∼N(x_0^T β,σ^2 x_0^T (X^T X)^{-1} x_0)$ se puede plantear el siguiente pivote

$$T=\frac{\hat Y_0 - x_0^T  \hat{\beta}} {S \sqrt{(x_0^T (X^T X)^{-1} x_0 )}} \sim t_{n-p}$$

En este caso 
$$T=\frac{\hat Y_0 - 28.47568} {0.347426} ∼t_{532}$$


Planteando el intervalo 

$$I=\left[\hat y_0-t_{n-p,1-α/2}\ S \sqrt{x_0^T (X^T X)^{-1} x_0},\ \ \hat y_0 +t_{n-p,1-α/2} \ S \sqrt{x_0^T (X^T X)^{-1} x_0} \right]$$
Para un nivel de confianza del `95%`, donde $\alpha=0.05$ se tiene que 

$I \approx [27.79319,29.15818]$

### Intervalo de predicción {-}
Sobre la base de lo planteado en el inciso anterior, se puede plantear que $\hat Y -Y_0∼N(0,σ^2+σ^2 x_0^T (X^T X)^{-1} x_0)$

De donde se ve que se puede plantear el siguiente pivote

$$T=\frac{\hat Y_0 - x_0^T  \hat{\beta}} {S \sqrt{1+x_0^T (X^T X)^{-1} \ x_0}} \sim t_{n-p}$$


En este caso

$$T=\frac{\hat Y_0 - 28.0764} {5.013457} ∼t_{532}$$

Planteando el intervalo 

$$I=\left[\hat y_0-t_{n-p,1-α/2}\ S \sqrt{1+x_0^T (X^T X)^{-1} x_0},\ \ \hat y_0 +t_{n-p,1-α/2} \ S \sqrt{1+x_0^T (X^T X)^{-1} x_0} \right]$$


Reemplazando, teniendo en cuenta que se pide un nivel de 0.95→α=0.05

$I \approx \left[18.6270,38.324288 \right]$

```{r}
#Se agrupan las variables requeridas para el test
data <- read.csv("data/diabetes2.csv", header = TRUE)
data$Outcome<-factor(data$Outcome)
data$Glucose<-as.numeric(data$Glucose)
data$BloodPressure<-as.numeric(data$BloodPressure)
data$SkinThickness<-as.numeric(data$SkinThickness)
data$Insulin<-as.numeric(data$Insulin)
S <- summary(Modelo8)$sigma
X <- cbind(rep(1,length(data$Pregnancies)),data.matrix(data[2]),data.matrix(data[4:5]),data.matrix(data[8:9])) #falta outcome el cual se agrega en la siguiente linea, ya que se tiene que acomodar el factor para la funcion indicatriz

X<-cbind(X,data.matrix(data[10])-1)

# Intervalo de confianza -------------
Den <- S*sqrt(t(X_0)%*%solve(t(X)%*%X)%*%X_0) #Denominador del estadistico T
alfa <- .05
t <- qt(1-alfa/2,532)
Inter_conf<-c(E_y0-t*Den,E_y0+t*Den)

#Se revisa mediante R
a <-data.frame(Pregnancies=2,BloodPressure=70,SkinThickness=20,DiabetesPedigreeFunction=.24,Age=30,Outcome= 0)
a$Outcome<-factor(a$Outcome, levels =c(0,1))
predict(Modelo8,a,interval="confidence", level=0.95)


# Intervalo de prediccion -------------
Den <- S*sqrt(1+t(X_0)%*%solve(t(X)%*%X)%*%X_0) #Denominador del estadistico T
Inter_pre<-c(E_y0-t*Den,E_y0+t*Den)
predict(Modelo8,a,interval='prediction', level=0.95)

```

## Ejercicio 10

_Selección de modelos. Plantear un nuevo modelo en el que intervengan aquellas variables que contribuyen significativamente y estimar los parámetros por mínimos cuadrados. ¿Qué modelo elegiría finalmente? Utilizar medidas de bondad de ajuste y de predicción, tal como la estimación del error cuadrático medio._

Para buscar este nuevo modelo se plantea el método Stepwise Best Subset. Donde se estudian todas las 2^k regresiones y elijo el que tenga mayor R_ajustado^2 a o mejor C_p. Siendo este único procedimiento que garantiza que se obtenga el modelo final que realmente optimiza la búsqueda del criterio elegido.

Donde 
C_P=(‖Y-Y ̂_p ‖^2  )/S^2 +2p-n
R_ajustado^2=1-(1-R^2 )n/(n-p)
Se ve que lo que se tiene que buscar es que  C_p≈p y que R_ajustado^2 sea el máximo posible
Los mejores subsets obtenidos son


Se calcularon y graficaron distintos estadísticos de bondad para comparar con que modelo quedarnos


De igual manera que lo planteado en el ejercicio 8, para la selección de modelos se buscaran mediante Stepwise Best Subset, con la diferencia de que en este caso se considerara la insulina como una de las variables a utilizar para la generación del modelo.  Obteniéndose los siguientes subconjuntos
Subsets	Número
SkinThickness	1
BloodPressure SkinThickness	2
BloodPressure SkinThickness Outcome1	3
BloodPressure SkinThickness Outcome1 Age	4
BloodPressure SkinThickness Age Outcome1
Insulin	5
BloodPressure SkinThickness Age Outcome1
Insulin DiabetesPedigreeFunction	6
BloodPressure SkinThickness Age Outcome1
Insulin DiabetesPedigreeFunction Pregnancies	7
BloodPressure SkinThickness Age Outcome1
Insulin DiabetesPedigreeFunction Pregnancies
Glucose	8

Se calcularon y graficaron distintos estadísticos de bondad para comparar con que modelo quedarnos

```{r}

library(ggplot2)
comb_opt <- regsubsets( BMI ~ Pregnancies + Glucose + BloodPressure + SkinThickness + Insulin + DiabetesPedigreeFunction + Age + Outcome, data = data, method = "exhaustive")


par(mfrow=c(2,2))
plot(summary(comb_opt)$rss,pch=21,xlab="Modelo", ylab= "RSS", main ="RSS del Modelo")
plot(summary(comb_opt)$rsq,pch=21,xlab="Modelo", ylab= "R^2", main ="R^2 del Modelo")
plot(summary(comb_opt)$adjr2,pch=21,xlab="Modelo", ylab= "R^2 aj", main ="R^2 ajustado del Modelo")
plot(1:8,summary(comb_opt)$cp,pch=21,ylim=c(0,10),xlab="Modelo", ylab= "CP", main ="Cp del Modelo")
abline(0,1)
summary(comb_opt)
Modelo_opt <-  lm( BMI ~  BloodPressure + SkinThickness + Insulin + DiabetesPedigreeFunction + Age + Outcome, data = data)
summary(Modelo_opt)

```

Donde se ve claramente que el modelo 6 es el que tienen mejor R_ajustado^2 y  C_p.  Vale aclarar que el modelo 7 también brinda un buen R_ajustado^2 y  C_p, pero es descartado debido a que posee mas variables por lo tanto se prefiere el modelo de 6 variables ya que conlleva a un menor sobreajuste.
Concluyéndose que el modelo que se plantea es:
Y=β_0  +β_1⋅ x_(Blood Pressure)+β_2⋅ x_(Skin Thickness)+β_3⋅ x_Insulin+β_4⋅ x_(Diabetes Pedigree Function)+β_5⋅ x_Age  +β_6  ⋅I(x_Outcome=1)  +ε

Parámetros del nuevo modelo

Coeficientes	Valor
β ̂_0 (Intercept)	16.12358
β ̂_1 (BloodPressure)	0.09253
β ̂_2 (SkinThickness)	0.37843
β ̂_3 (Insulin)	0.00473
β ̂_4 (DiabetesPedigreeFunction)	0.93026
β ̂_5 (Age)	-0.08087
β ̂_6 (Outcome1)	2.07514

	S	R_ajustado^2	F	p_valor
Modelo	4.976	0.4757	82.35	< 2.2e-16


## Ejercicio 11
_Validar los supuestos expresados en el ítem 2 a partir del análisis de los residuos, para el modelo seleccionado._
Los errores $ε_i$ son independientes entre sí y no están correlacionados con las covariables $x_i$ (Esto no va a ser demostrado)


<!-- Residuos de validación cruzada -->
<!-- Shapiro wilx test -->

<!-- https://www.youtube.com/watch?v=zb-WlauCVTA -->


